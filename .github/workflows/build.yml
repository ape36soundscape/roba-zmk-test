name: Build ZMK Firmware (robust)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  BOARD: seeeduino_xiao_ble
  SHIELD_LEFT:  roba_test_left
  SHIELD_RIGHT: roba_test_right
  ZMK_CFG_DIR: ${{ github.workspace }}/config
  APP_DIR: zmk/app

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install west
        run: |
          python -m pip install --upgrade pip
          pip install west
          west --version

      # ---- ZMK 本体を必ず用意 ----
      - name: Ensure ZMK source
        run: |
          set -e
          if [ ! -d "zmk/app" ]; then
            echo "📦 Cloning ZMK firmware..."
            git clone --depth=1 https://github.com/zmkfirmware/zmk.git zmk
          else
            echo "✅ ZMK source already present."
          fi

      # ---- west 初期化（ローカル ZMK を優先）----
      - name: Initialize ZMK workspace
        run: |
          set -e
          west init -l .
          west update || true
          west zephyr-export || true

          # ZMK/Zephyr の requirements は版でパスが違うので両対応
          if   [ -f zephyr/scripts/requirements.txt ]; then
            pip install -r zephyr/scripts/requirements.txt
          elif [ -f zephyr/scripts/requirements/requirements.txt ]; then
            pip install -r zephyr/scripts/requirements/requirements.txt
          else
            echo "⚠️ No Zephyr requirements file found. Continue."
          fi

      # ---- シールドを ZMK 側の探索パスに強制配置 ----
      - name: Make shields visible to ZMK
        run: |
          set -e
          mkdir -p zmk/config/boards/shields
          # 左右とも存在すればコピー（存在しない場合はスキップして警告）
          for side in "${SHIELD_LEFT}" "${SHIELD_RIGHT}"; do
            if [ -d "config/boards/shields/${side}" ]; then
              echo "🔗 Installing shield ${side}"
              rm -rf "zmk/config/boards/shields/${side}"
              cp -a  "config/boards/shields/${side}" "zmk/config/boards/shields/${side}"
            else
              echo "⚠️ Shield folder not found: config/boards/shields/${side} (skip copy)"
            fi
          done

      # ---- シールド定義の最低限チェック ----
      - name: Validate shields
        run: |
          fail=0
          for side in "${SHIELD_LEFT}" "${SHIELD_RIGHT}"; do
            if [ ! -f "zmk/config/boards/shields/${side}/zmk.yml" ]; then
              echo "❌ Missing zmk.yml for shield: ${side}"
              echo "   expected at: zmk/config/boards/shields/${side}/zmk.yml"
              fail=1
            else
              echo "✅ Found shield: ${side}"
            fi
          done
          if [ $fail -ne 0 ]; then
            echo "Shield validation failed. Please check names and files."
            exit 1
          fi

      # ---- 左ファームウェア ----
      - name: Build Left Firmware
        run: |
          set -e
          west build -p=always -b "${BOARD}" -d build/left "${APP_DIR}" \
            -- -DSHIELD="${SHIELD_LEFT}" -DZMK_CONFIG="${ZMK_CFG_DIR}"

      # ---- 右ファームウェア ----
      - name: Build Right Firmware
        run: |
          set -e
          west build -p=always -b "${BOARD}" -d build/right "${APP_DIR}" \
            -- -DSHIELD="${SHIELD_RIGHT}" -DZMK_CONFIG="${ZMK_CFG_DIR}"

      # ---- 成果物をアップロード ----
      - name: Upload UF2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zmk-uf2
          path: |
            build/left/zephyr/zmk.uf2
            build/right/zephyr/zmk.uf2
