name: Build ZMK Firmware (robust)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  # ★必要ならここだけあなたの値に揃えてください
  BOARD: seeeduino_xiao_ble
  SHIELD_LEFT:  roba_test_left
  SHIELD_RIGHT: roba_test_right

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python and west
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: |
          python -m pip install --upgrade pip
          pip install west pyyaml

      # ZMK 本体を取得
      - name: Fetch ZMK
        run: |
          set -eux
          test -d zmk || git clone --depth=1 https://github.com/zmkfirmware/zmk.git zmk

      # ZMK の manifest で west を初期化
      - name: Initialize west from ZMK
        run: |
          set -eux
          west init -l zmk
          west update
          west zephyr-export || true
          if   [ -f zephyr/scripts/requirements.txt ]; then
            pip install -r zephyr/scripts/requirements.txt
          elif [ -f zephyr/scripts/requirements/requirements.txt ]; then
            pip install -r zephyr/scripts/requirements/requirements.txt
          else
            echo "⚠️ Zephyr requirements.txt が見つからないため続行します"
          fi

      # プリフライト（何が見えているかをログ出力）
      - name: Preflight: show detected shields
        run: |
          set -eux
          echo "ZMK_CONFIG=$GITHUB_WORKSPACE/config"
          echo "SHIELD_LEFT=$SHIELD_LEFT  SHIELD_RIGHT=$SHIELD_RIGHT"
          echo "---- repo shields (config/boards/shields) ----"
          find config/boards/shields -maxdepth 2 -name zmk.yml -print -exec cat {} \; || true

      # 念のため zmk/config にも同名で複製（ZMK の探索パスに確実に載せる）
      - name: Copy shields into zmk/config (fallback)
        run: |
          set -eux
          mkdir -p zmk/config/boards/shields
          for s in "$SHIELD_LEFT" "$SHIELD_RIGHT"; do
            if [ -d "config/boards/shields/$s" ]; then
              rm -rf "zmk/config/boards/shields/$s"
              cp -a "config/boards/shields/$s" "zmk/config/boards/shields/$s"
            fi
          done
          echo "---- zmk/config shields ----"
          find zmk/config/boards/shields -maxdepth 2 -name zmk.yml -print -exec cat {} \; || true

      # 左右ビルド
      - name: Build Left Firmware
        run: |
          set -eux
          west build -p=always -b "$BOARD" -d build/left zmk/app \
            -- -DSHIELD="$SHIELD_LEFT" -DZMK_CONFIG="$GITHUB_WORKSPACE/config"

      - name: Build Right Firmware
        run: |
          set -eux
          west build -p=always -b "$BOARD" -d build/right zmk/app \
            -- -DSHIELD="$SHIELD_RIGHT" -DZMK_CONFIG="$GITHUB_WORKSPACE/config"

      # 成果物
      - name: Upload UF2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zmk-uf2
          path: |
            build/left/zephyr/zmk.uf2
            build/right/zephyr/zmk.uf2
