name: Build ZMK Firmware (robust)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  BOARD: seeeduino_xiao_ble
  SHIELD_LEFT:  roba_test_left
  SHIELD_RIGHT: roba_test_right
  ZMK_CFG_DIR: ${{ github.workspace }}/config
  APP_DIR: zmk/app

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install west
        run: |
          python -m pip install --upgrade pip
          pip install west
          west --version

      # ---- ZMK æœ¬ä½“ã‚’å¿…ãšç”¨æ„ ----
      - name: Ensure ZMK source
        run: |
          set -e
          if [ ! -d "zmk/app" ]; then
            echo "ğŸ“¦ Cloning ZMK firmware..."
            git clone --depth=1 https://github.com/zmkfirmware/zmk.git zmk
          else
            echo "âœ… ZMK source already present."
          fi

      # ---- west åˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« ZMK ã‚’å„ªå…ˆï¼‰----
      - name: Initialize ZMK workspace
        run: |
          set -e
          west init -l .
          west update || true
          west zephyr-export || true

          # ZMK/Zephyr ã® requirements ã¯ç‰ˆã§ãƒ‘ã‚¹ãŒé•ã†ã®ã§ä¸¡å¯¾å¿œ
          if   [ -f zephyr/scripts/requirements.txt ]; then
            pip install -r zephyr/scripts/requirements.txt
          elif [ -f zephyr/scripts/requirements/requirements.txt ]; then
            pip install -r zephyr/scripts/requirements/requirements.txt
          else
            echo "âš ï¸ No Zephyr requirements file found. Continue."
          fi

      # ---- ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ ZMK å´ã®æ¢ç´¢ãƒ‘ã‚¹ã«å¼·åˆ¶é…ç½® ----
      - name: Make shields visible to ZMK
        run: |
          set -e
          mkdir -p zmk/config/boards/shields
          # å·¦å³ã¨ã‚‚å­˜åœ¨ã™ã‚Œã°ã‚³ãƒ”ãƒ¼ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦è­¦å‘Šï¼‰
          for side in "${SHIELD_LEFT}" "${SHIELD_RIGHT}"; do
            if [ -d "config/boards/shields/${side}" ]; then
              echo "ğŸ”— Installing shield ${side}"
              rm -rf "zmk/config/boards/shields/${side}"
              cp -a  "config/boards/shields/${side}" "zmk/config/boards/shields/${side}"
            else
              echo "âš ï¸ Shield folder not found: config/boards/shields/${side} (skip copy)"
            fi
          done

      # ---- ã‚·ãƒ¼ãƒ«ãƒ‰å®šç¾©ã®æœ€ä½é™ãƒã‚§ãƒƒã‚¯ ----
      - name: Validate shields
        run: |
          fail=0
          for side in "${SHIELD_LEFT}" "${SHIELD_RIGHT}"; do
            if [ ! -f "zmk/config/boards/shields/${side}/zmk.yml" ]; then
              echo "âŒ Missing zmk.yml for shield: ${side}"
              echo "   expected at: zmk/config/boards/shields/${side}/zmk.yml"
              fail=1
            else
              echo "âœ… Found shield: ${side}"
            fi
          done
          if [ $fail -ne 0 ]; then
            echo "Shield validation failed. Please check names and files."
            exit 1
          fi

      # ---- å·¦ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ ----
      - name: Build Left Firmware
        run: |
          set -e
          west build -p=always -b "${BOARD}" -d build/left "${APP_DIR}" \
            -- -DSHIELD="${SHIELD_LEFT}" -DZMK_CONFIG="${ZMK_CFG_DIR}"

      # ---- å³ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ ----
      - name: Build Right Firmware
        run: |
          set -e
          west build -p=always -b "${BOARD}" -d build/right "${APP_DIR}" \
            -- -DSHIELD="${SHIELD_RIGHT}" -DZMK_CONFIG="${ZMK_CFG_DIR}"

      # ---- æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ----
      - name: Upload UF2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zmk-uf2
          path: |
            build/left/zephyr/zmk.uf2
            build/right/zephyr/zmk.uf2
